#!/bin/bash

# ะะตะทะพะฟะฐัะฝัะน ะดะตะฟะปะพะน ะขะะะฌะะ OCPP ัะตัะฒะตัะฐ ะะะ nginx
# ะะฐะฟััะบะฐัั ะฝะฐ ัะตัะฒะตัะต ะฟะพะด ะฟะพะปัะทะพะฒะฐัะตะปะตะผ ั sudo ะฟัะธะฒะธะปะตะณะธัะผะธ
# โ๏ธ ะะ ะะะะะะะะะกะซะะะะข .env ะคะะะ! โ๏ธ

set -e

echo "๐ ะะตะฟะปะพะน ัะธััะพะณะพ OCPP ัะตัะฒะตัะฐ (ะะะ nginx)..."

# ะะตัะตะผะตะฝะฝัะต
PROJECT_DIR="/opt/evpower-ocpp"
BACKEND_DIR="$PROJECT_DIR/backend"
SERVICE_NAME="evpower-ocpp"

# ะกะพะทะดะฐะฝะธะต ะฑัะบะฐะฟะฐ ัะตะบััะตะณะพ .env
if [ -f "$BACKEND_DIR/.env" ]; then
    cp "$BACKEND_DIR/.env" "$BACKEND_DIR/.env.backup.$(date +%Y%m%d_%H%M%S)"
    echo "โ ะกะพะทะดะฐะฝ ะฑัะบะฐะฟ .env ัะฐะนะปะฐ"
fi

# ะััะฐะฝะพะฒะบะฐ ัะตัะฒะธัะฐ
echo "โน๏ธ ะััะฐะฝะพะฒะบะฐ OCPP ัะตัะฒะธัะฐ..."
sudo systemctl stop $SERVICE_NAME || true

# ะััะฐะฝะพะฒะบะฐ nginx ะตัะปะธ ะพะฝ ะผะตัะฐะตั
echo "๐ซ ะัะบะปััะตะฝะธะต nginx ะพั ะฟะพััะฐ 8180..."
sudo rm -f /etc/nginx/sites-enabled/evpower-ocpp
sudo systemctl reload nginx || true

# ะะฑะฝะพะฒะปะตะฝะธะต ะบะพะดะฐ ะธะท GitHub
echo "๐ฅ ะะพะปััะตะฝะธะต ะพะฑะฝะพะฒะปะตะฝะธะน ะธะท GitHub..."
cd $PROJECT_DIR
git pull origin main

# ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั
echo "๐ ะะบัะธะฒะฐัะธั ะฒะธัััะฐะปัะฝะพะณะพ ะพะบััะถะตะฝะธั..."
cd $BACKEND_DIR
source venv/bin/activate

# ะะฑะฝะพะฒะปะตะฝะธะต ะทะฐะฒะธัะธะผะพััะตะน
echo "๐ฆ ะะฑะฝะพะฒะปะตะฝะธะต ะทะฐะฒะธัะธะผะพััะตะน..."
pip install -r requirements.txt

# ะะฑะฝะพะฒะปะตะฝะธะต systemd ัะตัะฒะธัะฐ
echo "โ๏ธ ะะฑะฝะพะฒะปะตะฝะธะต systemd ัะตัะฒะธัะฐ..."
if [ -f "ocpp-server.service" ]; then
    sudo cp ocpp-server.service /etc/systemd/system/$SERVICE_NAME.service
    sudo systemctl daemon-reload
    echo "โ Systemd ัะตัะฒะธั ะพะฑะฝะพะฒะปะตะฝ"
fi

# โ๏ธ ะะะะะะะกะะะกะขะฌ: ะะ ะะะะะะะะะกะซะะะะ .env!
echo "๐ก๏ธ ะัะพะฟััะบะฐะตะผ ะพะฑะฝะพะฒะปะตะฝะธะต .env ะดะปั ัะพััะฐะฝะตะฝะธั ัะฐะฑะพัะธั ะฝะฐัััะพะตะบ"
if [ -f "env.production.template" ]; then
    echo "โน๏ธ  ะจะฐะฑะปะพะฝ ะฝะฐัััะพะตะบ ะดะพัััะฟะตะฝ ะฒ env.production.template"
    echo "โน๏ธ  ะกะพะทะดะฐะนัะต .env ะฝะฐ ะพัะฝะพะฒะต ัะฐะฑะปะพะฝะฐ ะตัะปะธ ะฝัะถะฝะพ"
    echo "๐ ะะะะะ: ะะ ะดะพะฑะฐะฒะปัะนัะต ัะตะฐะปัะฝัะต ัะตะบัะตัั ะฒ Git!"
fi

# ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะธ ะปะพะณะพะฒ
echo "๐ ะกะพะทะดะฐะฝะธะต ะดะธัะตะบัะพัะธะธ ะปะพะณะพะฒ..."
sudo mkdir -p /var/log/evpower-ocpp
sudo chown evpower:evpower /var/log/evpower-ocpp

# ะัะพะฒะตัะบะฐ ััะพ ะฟะพัั 8180 ัะฒะพะฑะพะดะตะฝ
echo "๐ ะัะพะฒะตัะบะฐ ะฟะพััะฐ 8180..."
if sudo netstat -tlnp | grep :8180 | grep -v $SERVICE_NAME; then
    echo "โ ะะพัั 8180 ะทะฐะฝัั ะดััะณะธะผ ะฟัะพัะตััะพะผ!"
    echo "๐ ะะฐะฟััะตะฝะฝัะต ะฟัะพัะตััั ะฝะฐ ะฟะพััั 8180:"
    sudo lsof -i :8180
    echo "๐๏ธ ะััะฐะฝะพะฒะธัะต ะผะตัะฐััะธะต ะฟัะพัะตััั ะธ ะฟะพะฒัะพัะธัะต ะดะตะฟะปะพะน"
    exit 1
fi

# ะะฐะฟััะบ ะผะธะณัะฐัะธะน ะฑะฐะทั ะดะฐะฝะฝัั
echo "๐๏ธ ะัะฟะพะปะฝะตะฝะธะต ะผะธะณัะฐัะธะน ะฑะฐะทั ะดะฐะฝะฝัั..."
python -c "
from app.db.base_class import Base
from app.db.session import engine
Base.metadata.create_all(bind=engine)
print('ะะฐะทะฐ ะดะฐะฝะฝัั ะธะฝะธัะธะฐะปะธะทะธัะพะฒะฐะฝะฐ')
"

# ะะบะปััะตะฝะธะต ะธ ะทะฐะฟััะบ ัะตัะฒะธัะฐ
echo "๐ ะะฐะฟััะบ OCPP ัะตัะฒะธัะฐ..."
sudo systemctl enable $SERVICE_NAME
sudo systemctl start $SERVICE_NAME

# ะัะพะฒะตัะบะฐ ััะฐัััะฐ
echo "๐ ะัะพะฒะตัะบะฐ ััะฐัััะฐ ัะตัะฒะธัะฐ..."
sudo systemctl status $SERVICE_NAME --no-pager

# ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ
echo "โณ ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ ัะตัะฒะตัะฐ..."
sleep 10

# ะัะพะฒะตัะบะฐ health check
echo "๐ฅ ะัะพะฒะตัะบะฐ ัะฐะฑะพัะพัะฟะพัะพะฑะฝะพััะธ..."
if curl -f -s http://localhost:8180/health > /dev/null; then
    echo "โ OCPP ัะตัะฒะตั ััะฟะตัะฝะพ ะทะฐะฟััะตะฝ ะฝะฐ ะฟะพััั 8180"
    echo "๐ API ะดะพัััะฟะฝะพ: http://193.176.239.218:8180"
    echo "๐ ะะพะบัะผะตะฝัะฐัะธั: http://193.176.239.218:8180/docs"
    echo "๐ WebSocket: ws://193.176.239.218:8180/ws/{station_id}"
    echo "๐ ะกัะฐัะธััะธะบะฐ: http://193.176.239.218:8180/api/v1/ocpp/statistics/overview"
else
    echo "โ ะัะธะฑะบะฐ: ัะตัะฒะตั ะฝะต ะพัะฒะตัะฐะตั ะฝะฐ health check"
    echo "๐ ะัะพะฒะตัััะต ะปะพะณะธ: sudo journalctl -u $SERVICE_NAME -f"
    exit 1
fi

echo "๐ ะะตะฟะปะพะน ัะธััะพะณะพ OCPP ัะตัะฒะตัะฐ ะทะฐะฒะตััะตะฝ ััะฟะตัะฝะพ!"
echo "๐ก๏ธ ะคะฐะนะป .env ะะ ะะซะ ะะะะะะะ"
echo "๐ซ Nginx ะพัะบะปััะตะฝ ะพั ะฟะพััะฐ 8180"
echo "โก ะขะพะปัะบะพ FastAPI ะฝะฐ 8180 ะดะปั OCPP ััะฝะบัะธะน" 