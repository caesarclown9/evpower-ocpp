# EvPower OCPP Backend

üîå **Production-ready OCPP 1.6 WebSocket —Å–µ—Ä–≤–µ—Ä** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞—Ä—è–¥–Ω—ã–º–∏ —Å—Ç–∞–Ω—Ü–∏—è–º–∏ —ç–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª–µ–π —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π **Supabase**.

## üöÄ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ **OCPP 1.6** –ø–æ–ª–Ω–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–∞
- ‚úÖ **WebSocket** real-time —Å–≤—è–∑—å —Å–æ —Å—Ç–∞–Ω—Ü–∏—è–º–∏  
- ‚úÖ **Supabase** –æ–±–ª–∞—á–Ω–∞—è PostgreSQL –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ **Redis** pub/sub –¥–ª—è –∫–æ–º–∞–Ω–¥ —Å—Ç–∞–Ω—Ü–∏—è–º
- ‚úÖ **FastAPI** REST API —Å –∞–≤—Ç–æ–¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π
- ‚úÖ **–¢–∞—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è** –≥–∏–±–∫–∞—è —Å–∏—Å—Ç–µ–º–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏
- ‚úÖ **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** health checks –∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
- ‚úÖ **Production** –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Supabase)
```
users (5 –∑–∞–ø–∏—Å–µ–π)           ‚Üê –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã
‚îú‚îÄ‚îÄ charging_sessions        ‚Üê –°–µ—Å—Å–∏–∏ –∑–∞—Ä—è–¥–∫–∏ (—Å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º–∏ OCPP)
clients                      ‚Üê –ö–ª–∏–µ–Ω—Ç—ã/–∫–æ–º–ø–∞–Ω–∏–∏
locations (17 –∑–∞–ø–∏—Å–µ–π)       ‚Üê –õ–æ–∫–∞—Ü–∏–∏ —Å—Ç–∞–Ω—Ü–∏–π
‚îú‚îÄ‚îÄ stations (22 –∑–∞–ø–∏—Å–∏)     ‚Üê –ó–∞—Ä—è–¥–Ω—ã–µ —Å—Ç–∞–Ω—Ü–∏–∏
    ‚îú‚îÄ‚îÄ maintenance          ‚Üê –¢–µ—Ö–æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ
    ‚îú‚îÄ‚îÄ charging_sessions    ‚Üê –°–µ—Å—Å–∏–∏ –∑–∞—Ä—è–¥–∫–∏
    ‚îî‚îÄ‚îÄ tariff_plans         ‚Üê –¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã
        ‚îî‚îÄ‚îÄ tariff_rules     ‚Üê –ü—Ä–∞–≤–∏–ª–∞ —Ç–∞—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ (18 –∑–∞–ø–∏—Å–µ–π)
```

### OCPP Workflow
```
Station ‚Üí WebSocket ‚Üí OCPP Handler ‚Üí Database ‚Üí Response
                           ‚Üì
                      Redis Pub/Sub ‚Üê API Commands
```

## üìã –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Python 3.9+
- Redis Server
- –î–æ—Å—Ç—É–ø –∫ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç—É (–¥–ª—è Supabase)

## üõ†Ô∏è –£—Å—Ç–∞–Ω–æ–≤–∫–∞

1. **–ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è:**
```bash
git clone https://github.com/caesarclown9/evpower-ocpp.git
cd evpower-ocpp/backend
```

2. **–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:**
```bash
pip install -r requirements.txt
```

3. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è:**
```bash
cp env.example .env
```

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.env` —Ñ–∞–π–ª —Å –≤–∞—à–∏–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏:
```env
# Database settings for Supabase
DATABASE_URL=postgresql://postgres.fsoffzrngojgsigrmlui:Arma2000@aws-0-eu-north-1.pooler.supabase.com:6543/postgres
SUPABASE_URL=https://fsoffzrngojgsigrmlui.supabase.co
SUPABASE_ANON_KEY=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...

# Redis settings  
REDIS_URL=redis://localhost:6379

# Server settings
LOG_LEVEL=INFO
ALLOWED_HOSTS=*
```

4. **–ó–∞–ø—É—Å–∫ Redis:**
```bash
redis-server
```

5. **–°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö:**
```bash
python test_db.py
```

## üöÄ –ó–∞–ø—É—Å–∫

### Development —Ä–µ–∂–∏–º:
```bash
python app/main.py
```

### Production —Ä–µ–∂–∏–º:
```bash
uvicorn app.main:app --host 0.0.0.0 --port 8000 --workers 4
```

–°–µ—Ä–≤–µ—Ä –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:
- **API –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:** http://localhost:8000/docs
- **Health check:** http://localhost:8000/health
- **OCPP WebSocket:** ws://localhost:8000/ws/{station_id}

## üì° OCPP –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏:
```
WebSocket URL: ws://your-server.com/ws/STATION_ID
Subprotocol: ocpp1.6
```

### –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ OCPP —Å–æ–æ–±—â–µ–Ω–∏—è:
- ‚úÖ **BootNotification** - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å—Ç–∞–Ω—Ü–∏–∏
- ‚úÖ **Heartbeat** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–≤—è–∑–∏ (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
- ‚úÖ **StartTransaction** - –Ω–∞—á–∞–ª–æ –∑–∞—Ä—è–¥–∫–∏
- ‚úÖ **StopTransaction** - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –∑–∞—Ä—è–¥–∫–∏  
- ‚úÖ **MeterValues** - –ø–æ–∫–∞–∑–∞–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞
- ‚úÖ **RemoteStartTransaction** - –¥–∏—Å—Ç–∞–Ω—Ü–∏–æ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫
- ‚úÖ **RemoteStopTransaction** - –¥–∏—Å—Ç–∞–Ω—Ü–∏–æ–Ω–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞

## üõ†Ô∏è API –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã

### OCPP –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
```http
GET    /ocpp/connections              # –°–ø–∏—Å–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π
GET    /ocpp/status/{station_id}      # –°—Ç–∞—Ç—É—Å —Å—Ç–∞–Ω—Ü–∏–∏
POST   /ocpp/send_command             # –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã –Ω–∞ —Å—Ç–∞–Ω—Ü–∏—é
POST   /ocpp/start_charge             # –ó–∞–ø—É—Å–∫ –∑–∞—Ä—è–¥–∫–∏
```

### –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã–º–∏
```http
# –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
POST   /ocpp/users                    # –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
GET    /ocpp/users                    # –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
GET    /ocpp/users/{user_id}          # –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

# –°—Ç–∞–Ω—Ü–∏–∏  
POST   /ocpp/stations                 # –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏
GET    /ocpp/stations                 # –°–ø–∏—Å–æ–∫ —Å—Ç–∞–Ω—Ü–∏–π
GET    /ocpp/stations/{station_id}    # –î–∞–Ω–Ω—ã–µ —Å—Ç–∞–Ω—Ü–∏–∏
PUT    /ocpp/stations/{station_id}    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏

# –°–µ—Å—Å–∏–∏ –∑–∞—Ä—è–¥–∫–∏
POST   /ocpp/sessions                 # –°–æ–∑–¥–∞–Ω–∏–µ —Å–µ—Å—Å–∏–∏
GET    /ocpp/sessions                 # –°–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–π
GET    /ocpp/sessions/{session_id}    # –î–∞–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏

# –¢–∞—Ä–∏—Ñ—ã
POST   /ocpp/tariff_plans             # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–Ω–æ–≥–æ –ø–ª–∞–Ω–∞
GET    /ocpp/tariff_plans             # –°–ø–∏—Å–æ–∫ —Ç–∞—Ä–∏—Ñ–Ω—ã—Ö –ø–ª–∞–Ω–æ–≤
POST   /ocpp/tariff_rules             # –°–æ–∑–¥–∞–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–Ω–æ–≥–æ –ø—Ä–∞–≤–∏–ª–∞
GET    /ocpp/calculate_cost/{station_id}?energy_kwh=25.5  # –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
```

## üí∞ –¢–∞—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è

–°–∏—Å—Ç–µ–º–∞ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≥–∏–±–∫—É—é —Ç–∞—Ä–∏—Ñ–∏–∫–∞—Ü–∏—é:

### –¢–∏–ø—ã —Ç–∞—Ä–∏—Ñ–æ–≤:
- **per_kwh** - –∑–∞ –∫–∏–ª–æ–≤–∞—Ç—Ç-—á–∞—Å (15.0 KGS/–∫–í—Ç‚ãÖ—á)
- **per_minute** - –∑–∞ –º–∏–Ω—É—Ç—É –∑–∞—Ä—è–¥–∫–∏
- **session_fee** - —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–ª–∞—Ç–∞ –∑–∞ —Å–µ—Å—Å–∏—é
- **parking_fee** - –ø–ª–∞—Ç–∞ –∑–∞ –ø–∞—Ä–∫–æ–≤–∫—É

### –ü—Ä–∏–º–µ—Ä —Ä–∞—Å—á–µ—Ç–∞:
```python
# 25.5 –∫–í—Ç‚ãÖ—á √ó 15.0 KGS/–∫–í—Ç‚ãÖ—á = 382.5 KGS
GET /ocpp/calculate_cost/station_id?energy_kwh=25.5
```

## üîß –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –¢–µ—Å—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ:
```bash
python test_db.py
```

### –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç OCPP –æ–ø–µ—Ä–∞—Ü–∏–π:
```bash
python test_ocpp_crud.py
```

### –ü—Ä–∏–º–µ—Ä —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–≤–æ–¥–∞:
```
üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ OCPP –æ–ø–µ—Ä–∞—Ü–∏–π —Å Supabase...

1. –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...
‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ–∑–¥–∞–Ω: test_1748379539@evpower.kg

2. –°–æ–∑–¥–∞–Ω–∏–µ –ª–æ–∫–∞—Ü–∏–∏... 
‚úÖ –õ–æ–∫–∞—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞: 43cb1ce0-15d0-4911-b339-5b0c3fd41281

5. –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞–Ω—Ü–∏–∏...
‚úÖ –°—Ç–∞–Ω—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∞: TEST-1748379539

7. –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∑–∞—Ä—è–¥–∫–∏...
‚úÖ –°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞—Ä—è–¥–∫–∏ 25.5 –∫–í—Ç*—á: {'cost': 382.5, 'currency': 'KGS'}

üéâ –í—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ OCPP —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö Supabase!
```

## üåê Production –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

–ü—Ä–æ–µ–∫—Ç –≥–æ—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ:

1. **–ù–∞—Å—Ç—Ä–æ–π–∫–∞ Nginx** (HTTP-only –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞–Ω—Ü–∏—è–º–∏):
```nginx
server {
    listen 80;
    server_name your-server.com;
    
    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
}
```

2. **Systemd —Å–µ—Ä–≤–∏—Å:**
```bash
sudo cp ocpp-server.service /etc/systemd/system/
sudo systemctl enable ocpp-server
sudo systemctl start ocpp-server
```

3. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥:**
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–∏—Å–∞
curl http://your-server.com/health

# –õ–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞
sudo journalctl -u ocpp-server -f
```

## üìä –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ (—Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ):
- **–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:** 5 –∑–∞–ø–∏—Å–µ–π
- **–õ–æ–∫–∞—Ü–∏–∏:** 17 –∑–∞–ø–∏—Å–µ–π  
- **–°—Ç–∞–Ω—Ü–∏–∏:** 22 –∑–∞–ø–∏—Å–∏
- **–¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã:** 6 –∑–∞–ø–∏—Å–µ–π
- **–¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø—Ä–∞–≤–∏–ª–∞:** 18 –∑–∞–ø–∏—Å–µ–π
- **–°–µ—Å—Å–∏–∏ –∑–∞—Ä—è–¥–∫–∏:** –∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è

### –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:
- ‚úÖ –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã –¥–ª—è –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- ‚úÖ Connection pooling –Ω–∞—Å—Ç—Ä–æ–µ–Ω
- ‚úÖ –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è real-time OCPP –æ–ø–µ—Ä–∞—Ü–∏–π

## üõ°Ô∏è –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ Pydantic
- ‚úÖ SQL injection –∑–∞—â–∏—Ç–∞ —á–µ—Ä–µ–∑ SQLAlchemy ORM
- ‚úÖ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è production
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- ‚úÖ Health checks –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–í—Å–µ OCPP –æ–ø–µ—Ä–∞—Ü–∏–∏ –ª–æ–≥–∏—Ä—É—é—Ç—Å—è:
```
2024-01-28 12:00:00 - ChargePoint.TEST-001 - INFO - üîå BootNotification: AC-22kW, EVPower
2024-01-28 12:05:00 - ChargePoint.TEST-001 - INFO - ‚ñ∂Ô∏è StartTransaction: connector=1, meter_start=1000
2024-01-28 12:30:00 - ChargePoint.TEST-001 - INFO - ‚èπÔ∏è StopTransaction: energy=25.5kWh, amount=382.5 KGS
```

## üîó –ü–æ–ª–µ–∑–Ω—ã–µ —Å—Å—ã–ª–∫–∏

- [OCPP 1.6 Specification](https://www.openchargealliance.org/)
- [FastAPI Documentation](https://fastapi.tiangolo.com/)
- [Supabase Documentation](https://supabase.com/docs)
- [Redis Documentation](https://redis.io/documentation)

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –≤–æ–ø—Ä–æ—Å–æ–≤:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏: `sudo journalctl -u ocpp-server`
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ Redis –∑–∞–ø—É—â–µ–Ω: `redis-cli ping`
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ health check: `curl http://localhost:8000/health`

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT License - —Å–º. —Ñ–∞–π–ª LICENSE –¥–ª—è –¥–µ—Ç–∞–ª–µ–π.

---

**Made with ‚ù§Ô∏è for EV charging infrastructure** 