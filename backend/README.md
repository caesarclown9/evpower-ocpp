# EvPower OCPP WebSocket Server

**–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π OCPP 1.6 WebSocket —Å–µ—Ä–≤–µ—Ä –¥–ª—è –∑–∞—Ä—è–¥–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π —ç–ª–µ–∫—Ç—Ä–æ–º–æ–±–∏–ª–µ–π**

## üéØ –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–≠—Ç–æ—Ç —Å–µ—Ä–≤–µ—Ä –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç **—Ç–æ–ª—å–∫–æ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è** –¥–ª—è –∑–∞—Ä—è–¥–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π –ø–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É OCPP 1.6. 

**HTTP API endpoints —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –æ—Ç–¥–µ–ª—å–Ω–æ –≤ FlutterFlow –ø—Ä–æ–µ–∫—Ç–µ** –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.

## üîå Endpoints

### **WebSocket**
```
ws://193.176.239.218:8180/ws/{station_id}
```
- –û—Å–Ω–æ–≤–Ω–æ–π endpoint –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –≠–ó–°
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç OCPP 1.6 JSON –ø—Ä–æ—Ç–æ–∫–æ–ª

### **HTTP (–º–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ)**
```
GET /health - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è —Å–µ—Ä–≤–µ—Ä–∞
GET /      - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Ä–≤–µ—Ä–µ
```

## üìã –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ OCPP —Å–æ–æ–±—â–µ–Ω–∏—è

### **–û—Ç —Å—Ç–∞–Ω—Ü–∏–∏ –∫ —Å–µ—Ä–≤–µ—Ä—É (Call)**
- `BootNotification` - —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å—Ç–∞–Ω—Ü–∏–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ
- `Heartbeat` - –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ —Å–∏–≥–Ω–∞–ª—ã –∂–∏–∑–Ω–∏ 
- `StatusNotification` - –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –∫–æ–Ω–Ω–µ–∫—Ç–æ—Ä–æ–≤
- `Authorize` - –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è RFID –∫–∞—Ä—Ç
- `StartTransaction` - –Ω–∞—á–∞–ª–æ —Å–µ–∞–Ω—Å–∞ –∑–∞—Ä—è–¥–∫–∏
- `StopTransaction` - –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ–∞–Ω—Å–∞ –∑–∞—Ä—è–¥–∫–∏
- `MeterValues` - –ø–æ–∫–∞–∑–∞–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤ —ç–Ω–µ—Ä–≥–∏–∏

### **–û—Ç —Å–µ—Ä–≤–µ—Ä–∞ –∫ —Å—Ç–∞–Ω—Ü–∏–∏ (Call)**
- `RemoteStartTransaction` - —É–¥–∞–ª–µ–Ω–Ω—ã–π –∑–∞–ø—É—Å–∫ –∑–∞—Ä—è–¥–∫–∏
- `RemoteStopTransaction` - —É–¥–∞–ª–µ–Ω–Ω–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞—Ä—è–¥–∫–∏
- `ChangeConfiguration` - –∏–∑–º–µ–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç–∞–Ω—Ü–∏–∏
- `GetConfiguration` - –ø–æ–ª—É—á–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ —Å—Ç–∞–Ω—Ü–∏–∏

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö (Supabase)

### **OCPP —Ç–∞–±–ª–∏—Ü—ã:**
- `ocpp_station_status` - —Å—Ç–∞—Ç—É—Å—ã —Å—Ç–∞–Ω—Ü–∏–π –∏ heartbeat
- `ocpp_transactions` - —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∑–∞—Ä—è–¥–∫–∏  
- `ocpp_meter_values` - –ø–æ–∫–∞–∑–∞–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–æ–≤
- `ocpp_authorization` - –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã–µ RFID –∫–∞—Ä—Ç—ã
- `ocpp_configuration` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Å—Ç–∞–Ω—Ü–∏–π

### **–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã:**
- `stations` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞–Ω—Ü–∏—è—Ö
- `users` - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã
- `charging_sessions` - —Å–µ–∞–Ω—Å—ã –∑–∞—Ä—è–¥–∫–∏
- `locations` - –ª–æ–∫–∞—Ü–∏–∏ —Å—Ç–∞–Ω—Ü–∏–π

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### **Production —Å–µ—Ä–≤–µ—Ä:**
- **Host:** 193.176.239.218:8180
- **–ü—Ä–æ—Ç–æ–∫–æ–ª:** OCPP 1.6 JSON over WebSocket
- **Reverse Proxy:** nginx
- **Systemd Service:** evpower-ocpp.service

### **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ deployment:**
```
FastAPI (0.0.0.0:8000) ‚Üê nginx (0.0.0.0:8180) ‚Üê –ò–Ω—Ç–µ—Ä–Ω–µ—Ç
```

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### **Environment –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ (.env):**
```bash
SUPABASE_URL=https://fsoffzrngojgsigrmlui.supabase.co
SUPABASE_KEY=your_anon_key
REDIS_URL=redis://localhost:6379
ALLOWED_HOSTS=193.176.239.218,localhost
LOG_LEVEL=INFO
```

### **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Redis:**
- **–ö–∞–Ω–∞–ª—ã:** `ocpp_commands_{station_id}` –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω—ã—Ö –∫–æ–º–∞–Ω–¥
- **–ö–ª—é—á–∏:** `ocpp_stations` –¥–ª—è —Å–ø–∏—Å–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —Å—Ç–∞–Ω—Ü–∏–π

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### **Health Check:**
```bash
curl http://193.176.239.218:8180/health
```

### **–õ–æ–≥–∏ —Å–µ—Ä–≤–∏—Å–∞:**
```bash
sudo journalctl -u evpower-ocpp.service -f
```

### **–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —Å—Ç–∞–Ω—Ü–∏–∏:**
```bash
redis-cli SMEMBERS ocpp_stations
```

## üîç Troubleshooting

### **–ü—Ä–æ–±–ª–µ–º—ã –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å nginx –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å firewall (–ø–æ—Ä—Ç 8180)
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞

### **–ü—Ä–æ–±–ª–µ–º—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Supabase URL –∏ –∫–ª—é—á–∏
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å foreign key constraints
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

### **–ü—Ä–æ–±–ª–µ–º—ã —Å Redis:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Redis —Å–µ—Ä–≤–∏—Å
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ localhost:6379
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–∞–º—è—Ç—å Redis

## üìÅ –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
backend/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ main.py              # FastAPI –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (–º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ)
‚îÇ   ‚îú‚îÄ‚îÄ core/config.py       # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ db/                  # –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ models/ocpp.py   # OCPP –º–æ–¥–µ–ª–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ session.py       # –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
‚îÇ   ‚îî‚îÄ‚îÄ crud/ocpp_service.py # OCPP –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
‚îú‚îÄ‚îÄ ocpp_ws_server/          # WebSocket —Å–µ—Ä–≤–µ—Ä
‚îÇ   ‚îú‚îÄ‚îÄ ws_handler.py        # –û–±—Ä–∞–±–æ—Ç—á–∏–∫ WebSocket
‚îÇ   ‚îú‚îÄ‚îÄ ocpp_dispatcher.py   # OCPP –¥–∏—Å–ø–µ—Ç—á–µ—Ä
‚îÇ   ‚îî‚îÄ‚îÄ redis_manager.py     # Redis –º–µ–Ω–µ–¥–∂–µ—Ä
‚îî‚îÄ‚îÄ requirements.txt         # –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
```

## üîó –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### **–†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏:**
- **Backend (—ç—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç):** –¢–æ–ª—å–∫–æ OCPP WebSocket –ø—Ä–æ—Ç–æ–∫–æ–ª –¥–ª—è –≠–ó–°
- **FlutterFlow:** HTTP API + –º–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ + –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
- **Supabase:** –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö + Auth + Real-time
- **Redis:** –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ + pub/sub –¥–ª—è –∫–æ–º–∞–Ω–¥

### **–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞:**
- ‚úÖ –ß–µ—Ç–∫–æ–µ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ backend/frontend
- ‚úÖ –ù–µ–∑–∞–≤–∏—Å–∏–º–æ–µ —Ä–∞–∑–≤–∏—Ç–∏–µ –ø—Ä–æ–µ–∫—Ç–æ–≤  
- ‚úÖ –°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –Ω–∞ OCPP –ø—Ä–æ—Ç–æ–∫–æ–ª–µ
- ‚úÖ –ü—Ä–æ—Å—Ç–æ—Ç–∞ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏—è –∏ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã

- **–ü—Ä–æ–µ–∫—Ç:** EvPower OCPP Server
- **–í–µ—Ä—Å–∏—è:** 1.0.0
- **–°–µ—Ä–≤–µ—Ä:** 193.176.239.218:8180

**–ì–æ—Ç–æ–≤ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üöÄ** 