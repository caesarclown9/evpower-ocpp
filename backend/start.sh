#!/bin/bash

echo "üöÄ Starting EvPower OCPP Server..."
echo "üìç Domain: https://ocpp.evpower.kg"
echo "üåê HTTP API: Port 9210"
echo "‚ö° WebSocket: Port 80 (OCPP standard)"

# –£–∂–µ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ /app –ø–æ—Å–ª–µ COPY backend/ .
echo "Working directory: $(pwd)"
echo "Contents: $(ls -la)"

# –°–æ–∑–¥–∞—Ç—å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤ –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≤—Å–µ –µ—â–µ –ø—ã—Ç–∞–µ—Ç—Å—è –∏—Ö –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
mkdir -p logs

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∏–≥–Ω–∞–ª–æ–≤
cleanup() {
    echo "üõë –ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –æ—Å—Ç–∞–Ω–æ–≤–∫–∏. –ó–∞–≤–µ—Ä—à–∞–µ–º –≤—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã..."
    # –£–±–∏–≤–∞–µ–º –≤—Å–µ –¥–æ—á–µ—Ä–Ω–∏–µ –ø—Ä–æ—Ü–µ—Å—Å—ã
    kill -TERM "$FASTAPI_PID" "$OCPP_PID" 2>/dev/null
    wait "$FASTAPI_PID" "$OCPP_PID" 2>/dev/null
    echo "‚úÖ –í—Å–µ –ø—Ä–æ—Ü–µ—Å—Å—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã"
    exit 0
}

# –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∏–≥–Ω–∞–ª–æ–≤ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
trap cleanup SIGTERM SIGINT

# –ó–∞–ø—É—Å–∫ FastAPI –Ω–∞ –ø–æ—Ä—Ç—É 9210
echo "üåê –ó–∞–ø—É—Å–∫ FastAPI –Ω–∞ –ø–æ—Ä—Ç—É 9210..."
python -m uvicorn app.main:app --host 0.0.0.0 --port 9210 &
FASTAPI_PID=$!

# –ó–∞–ø—É—Å–∫ OCPP WebSocket —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É 80
echo "‚ö° –ó–∞–ø—É—Å–∫ OCPP WebSocket —Å–µ—Ä–≤–µ—Ä–∞ –Ω–∞ –ø–æ—Ä—Ç—É 80..."
OCPP_WS_PORT=80 python -m ocpp_ws_server.server &
OCPP_PID=$!

echo "‚úÖ –û–±–∞ —Å–µ—Ä–≤–∏—Å–∞ –∑–∞–ø—É—â–µ–Ω—ã:"
echo "   - FastAPI PID: $FASTAPI_PID (–ø–æ—Ä—Ç 9210)"
echo "   - OCPP WS PID: $OCPP_PID (–ø–æ—Ä—Ç 80)"

# –û–∂–∏–¥–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ª—é–±–æ–≥–æ –∏–∑ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤
wait -n $FASTAPI_PID $OCPP_PID

# –ï—Å–ª–∏ –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≤–µ—Ä—à–∏–ª—Å—è, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ç–æ—Ä–æ–π
echo "‚ö†Ô∏è  –û–¥–∏–Ω –∏–∑ –ø—Ä–æ—Ü–µ—Å—Å–æ–≤ –∑–∞–≤–µ—Ä—à–∏–ª—Å—è. –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ..."
cleanup 